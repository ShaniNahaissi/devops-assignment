# DevOps Assignment

[![Call API Status](https://github.com/ShaniNahaissi/devops-assignment/actions/workflows/call-api.yml/badge.svg)](https://github.com/ShaniNahaissi/devops-assignment/actions/workflows/call-api.yml)

A Node.js API with GitHub Actions automation demonstrating CI/CD principles and DevOps best practices.

## Features

- Custom GitHub Action for API interaction
- Automated README updates via workflow
- Security-hardened CI/CD pipeline
- Express.js REST API with health check endpoint
- Unit tests with Jest and Supertest

## Quick Start
```bash
# Install dependencies
npm install

# Start the server
npm start

# Test the endpoint
curl http://localhost:3000/status

# Run tests
npm test
```

## Architecture
```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────┐
│ GitHub Actions  │────▶│ Custom Action    │────▶│ Node.js API │
│ Workflow        │     │ (call-node-api)  │     │ /status     │
└─────────────────┘     └──────────────────┘     └─────────────┘
                               │
                               ▼
                        ┌──────────────┐
                        │ README.md    │
                        │ (Updated)    │
                        └──────────────┘
```

## API Endpoints

| Endpoint  | Method | Description | Response |
|-----------|--------|-------------|----------|
| `/status` | GET    | Service status | `{status, service, timestamp}` |
| `/health` | GET    | Health check | `{healthy: true}` |

**Example response (`/status`):**
```json
{
  "status": "ok",
  "service": "devops-assignment",
  "timestamp": "2025-01-15T10:30:00.000Z"
}
```

**Example response (`/health`):**
```json
{
  "healthy": true
}
```

## Workflow

The GitHub Actions workflow:

1. Installs dependencies
2. Runs tests (fails fast if tests break)
3. Builds the custom action
4. Starts the API server in the background
5. Waits for the API to be ready
6. Calls the `/status` endpoint via custom action
7. Updates this README with the response
8. Commits and pushes changes automatically

**Trigger:** Manual (`workflow_dispatch`)

## Security

- Action versions pinned to SHA for immutability
- Minimal permissions (`contents: write` only)
- URL validation in custom action
- Environment variables used to prevent script injection

> **Note:** The workflow uses HTTP for localhost communication within the CI runner. For production deployments, HTTPS should be configured with proper certificates.

## Project Structure
```
devops-assignment/
├── .github/
│   ├── actions/
│   │   └── call-node-api/        # Custom GitHub Action
│   │       ├── dist/
│   │       │   └── index.js      # Built output (generated by Rollup) only on runner
│   │       ├── action.yml        # Action metadata
│   │       ├── index.js          # Action source code
│   │       ├── package.json
│   │       ├── package-lock.json
│   │       └── rollup.config.js  # Bundler configuration
│   └── workflows/
│       └── call-api.yml          # Main workflow
├── src/
│   ├── server.js                 # Express API server
│   └── server.test.js            # API tests (Jest)
├── .gitignore
├── package.json
├── package-lock.json
└── README.md
```

### Why Bundle the Action?

GitHub Actions requires all dependencies to be available at runtime. Instead of committing the entire `node_modules/` folder (thousands of files), we use Rollup to bundle `index.js` and its dependencies into a single `dist/index.js` file. This keeps the repository clean and speeds up action execution.

## Testing

Run the tests:
```bash
npm test
```

Tests cover:

- Health endpoint returns `200` with `{ healthy: true }`
- Status endpoint returns correct structure
- Timestamp is valid ISO format

Tests run automatically in the CI workflow before the API is started. If tests fail, the workflow stops immediately — **fail fast** principle.

## Custom Action Outputs

The `call-node-api` action provides these outputs for use in subsequent steps:

| Output | Description |
|--------|-------------|
| `status` | API status (e.g., "ok") |
| `service` | Service name |
| `response-time-ms` | Response time in milliseconds |

<!-- API_STATUS_START -->
## API Status
        - **Status:** ok
        - **Service:** devops-assignment
        - **Timestamp:** 2025-12-08T16:47:40.826Z
<!-- API_STATUS_END -->